name: RDP-Linux-Ngrok

on:
  workflow_dispatch:

jobs:
  rdp-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Desktop & XRDP
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies xrdp dbus-x11 curl jq
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: Create RDP User
        run: |
          USERNAME=rdpuser
          PASSWORD=Rdp123!

          sudo useradd -m $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USERNAME

          echo "xfce4-session" | sudo tee /home/$USERNAME/.xsession > /dev/null
          sudo chown $USERNAME:$USERNAME /home/$USERNAME/.xsession

          echo "==============================="
          echo "RDP LOGIN"
          echo "Username: $USERNAME"
          echo "Password: $PASSWORD"
          echo "==============================="

      - name: Install Ngrok (OFFICIAL & FIX)
        run: |
          curl -fsSL https://ngrok.com/install.sh | sudo bash
          ngrok version

      - name: Start Ngrok TCP 3389
        run: |
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

          # Jalankan ngrok di background
          nohup ngrok tcp 3389 > ngrok.log 2>&1 &
          sleep 10

          # Ambil address ngrok
          ADDR=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')

          if [ -z "$ADDR" ] || [ "$ADDR" = "null" ]; then
            echo "Gagal mendapatkan alamat ngrok"
            exit 1
          fi

          echo "NGROK_ADDR=$ADDR" >> $GITHUB_ENV
          echo "NGROK ADDRESS: $ADDR"

      - name: Keep RDP Alive
        run: |
          echo "================================="
          echo "RDP LINUX (NGROK) AKTIF"
          echo "ADDRESS : $NGROK_ADDR"
          echo "USERNAME: rdpuser"
          echo "PASSWORD: Rdp123!"
          echo "================================="

          # Tahan runner 6 jam
          sleep 21600
