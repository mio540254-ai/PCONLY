name: RDP-Linux-Ngrok

on:
  workflow_dispatch:

jobs:
  rdp-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Desktop & XRDP
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies xrdp dbus-x11 curl unzip
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: Create RDP User
        run: |
          USERNAME=rdpuser
          PASSWORD='Rdp123!@#'

          sudo useradd -m $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USERNAME

          echo "xfce4-session" | sudo tee /home/$USERNAME/.xsession > /dev/null
          sudo chown $USERNAME:$USERNAME /home/$USERNAME/.xsession

          echo "===================="
          echo "RDP LOGIN"
          echo "Username: $USERNAME"
          echo "Password: $PASSWORD"
          echo "===================="

      - name: Install Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok-linux-amd64.zip -o ngrok.zip
          unzip ngrok.zip
          sudo mv ngrok /usr/local/bin/ngrok
          ngrok version

      - name: Start Ngrok TCP 3389
        run: |
          ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

          # Jalankan ngrok di background
          nohup ngrok tcp 3389 > ngrok.log 2>&1 &

          sleep 10

          # Ambil alamat TCP dari API lokal ngrok
          NGROK_ADDR=$(curl -s http://127.0.0.1:4040/api/tunnels \
            | jq -r '.tunnels[0].public_url' | sed 's#tcp://##')

          if [ -z "$NGROK_ADDR" ]; then
            echo "Gagal mendapatkan alamat ngrok"
            exit 1
          fi

          echo "NGROK_ADDR=$NGROK_ADDR" >> $GITHUB_ENV
          echo "Ngrok Address: $NGROK_ADDR"

      - name: Keep RDP Alive
        run: |
          echo "================================="
          echo "RDP LINUX (NGROK)"
          echo "ADDRESS : $NGROK_ADDR"
          echo "PORT    : otomatis"
          echo "USERNAME: rdpuser"
          echo "PASSWORD: Rdp123!@#"
          echo "================================="

          sleep 21600
